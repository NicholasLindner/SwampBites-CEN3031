{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <style>
        table {
            border-collapse: collapse;
            background: white;
            color: black;
            border: 1px solid black;
            width: 100%;
            table-layout: fixed;
            height: 55vh;
        }
         
        th, td {
            border: 1px solid black;
            text-align: left;
            padding: 8px;
            vertical-align: top;
            width: 10%
        }

        td:hover {background-color: lightcyan;}

        .highlight {
            background-color: #FFD700; /* Gold background for today's date */
        }

        .highlight:hover {
            background-color: #EFF37F;
        }

        .selected {
            background-color: rgb(255, 246, 190);
        }

        .selected:hover {
            background-color: rgb(248, 255, 230);
        }

        .month-year-buttons {
            margin-top: 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .calendar-container {
            padding-top: 10px;
        }

        .table-header {
            height: 10px;
            background: orange;
            color: black;
        }

        .date-number {
            position: relative;
            top: 0;
            left: 0;
            padding: 5px;
            font-weight: bold;
        }

        .num-shifts {
            position: relative;
            bottom: 0;
            right: 0;
            padding: 5px;
        }

        #revealDetailsButton {
            position: fixed; /* Fixed position relative to the viewport */
            bottom: 20px;   /* 20 pixels from the bottom */
            left: 20px;     /* 20 pixels from the left */
            padding: 10px 20px;
            background-color: #1a91e0; /* The color you've been using */
            color: white;
            font-size: 16px;
            border: none;
            cursor: pointer;
        }

        .shift-buttons {
            position: absolute;
            right: 40px;
            bottom: 40px;
            height: 7%;
            width:10%;

            background-color: #1a91e0;
            color: white;
            font-size: 16px;
            border: none;
            cursor: pointer;
        }

        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 50%; /* Could be more or less, depending on screen size */
        }

        .row {
            display: flex;
        }
        
        .row > * {
            flex: 1;
            margin-right: 10px;
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .reveal-details-button-container {
            position: fixed;
            left: 0;
            bottom: 0;
            padding: 10px;
        }

        .shift-details {
            width: 50%;
            display: flex;
            justify-content: space-between;
        }
        
        .shift-display-header {
            text-align: center;
        }

        .shift-display {    
            list-style-type: none;
            padding: 20px;
            margin: 0;
            text-align: center;
        }

        .shift-display li {
            display: inline-block;
            text-align: left;
            padding-top: 5px;
            padding-bottom: 5px;
            padding-left: 30px;
            padding-right: 30px
        }

        .shift-display li:hover {
            background-color: rgb(228, 228, 228);
        }

        .shift-display-selected {
            background-color: rgb(228, 228, 228);
        }
    </style>
        </head>
        <body>
            <div class="container">
                
                <div id="monthYear" class="text-center font-weight-bold month-year-buttons">
                    <button onclick="changeMonth(-1)" id="prev">&#10094;</button>
                    <span style="font-size: 24px;">Month / Year</span>
                    <button onclick="changeMonth(1)" id="next">&#10095;</button>
                </div>
                <div class="calendar-container">
                    <table>
                        <thead>
                            <tr class="table-header">
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- calendar days will bbe generated by javaScript -->
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- The modal -->
            <div id="myModal" class="modal">
                <!-- modal content -->
                <div class="modal-content">
                <span class="close">&times;</span>
                <p>Some text in the Modal..</p>
                </div>
            </div>

    <div id="employeeListModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('employeeListModal')">&times;</span>
            <h2>Select an Employee</h2>
            <div class="row">
                <select id="employeeDropdown"></select>
                <select id="typeDropdown">
                    <option>Morning</option>
                    <option>Evening</option>
                    <option>Night</option>
                </select>
                <button id="submitButton">Submit</button>
                <p id="output"></p>
            </div>
        </div>
    </div>

    
    <div id="shiftListModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('shiftListModal')">&times;</span>
            <h2>Shifts List</h2>
            <ul id="shiftList">
                <!-- Employee list will be populated here -->
            </ul>
        </div>
    </div>

    <br>
    <center>
        <div class="shift-details">
            <span style="width: 50%">
                <h2 class="shift-display-header"><u> Morning </u></h2>
                <ul id="shift-first" class="shift-display"></ul>
            </span>
            <span style="width: 50%">
                <h2 class="shift-display-header"><u> Evening </u></h2>
                <ul id="shift-second" class="shift-display"></ul>
            </span>
            <span style="width: 50%">
                <h2 class="shift-display-header"><u> Night </u></h2>
                <ul id="shift-third" class="shift-display"></ul>
            </span>
        </div>
    </center>
    

            {% if current_user.is_authenticated and current_user.role == 'manager' %}
                <div id="shift-buttons" class="text-center font-weight-bold">
                    <button id="add-remove-button"class="shift-buttons">Add Shift</button>
                </div>
            {% endif %}

            
            <!-- <div class="reveal-details-button-container">
                <button id="revealDetailsButton">Reveal Details</button>
            </div> -->

            <!--
            <div class="text-center font-weight-bold">
                <button id="revealDetailsButton">Reveal Details</button>
            </div>
        -->


        
        </body>
        </html>

{% endblock %}

{% block javascript %}
<script>
    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    let selectedMonth = -1;
    let selectedDate = -1;

    let selectedEmployee = null;
    let selectedType = null;

    let selectedShift = null;

    let startDay = 0;
    let daysInMonth = 0;

    const months = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];

    document.addEventListener("DOMContentLoaded", function() {
        renderCalendar(currentMonth, currentYear);
    });

    let shifts = [];

    function changeMonth(direction) {
        currentMonth += direction;
        if (currentMonth < 0 || currentMonth > 11) {
            currentMonth -= direction; // Prevents moving outside the current year
        }
        renderCalendar(currentMonth, currentYear);
    }

    document.getElementById('shift-buttons').addEventListener('click', function() {
        if (selectedShift == null){
            addShift();
        }
        else {
            deleteShift();
        }
    });

    function addShift() {
        let cells = document.getElementById("calendarBody").getElementsByClassName("selected");
        if (cells.length > 0) {
            cell = cells[0];
            let month = JSON.parse(cell.dataset.month);
            let day = JSON.parse(cell.dataset.date);
            
            fetch('/get-employees', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            }).then(response => {
                return response.json();
            }).then(data => {
                let employeeDropdown = document.getElementById('employeeDropdown');
                let typeDropdown = document.getElementById('typeDropdown');
                let submitButton = document.getElementById('submitButton');
                employeeDropdown.innerHTML = '';
                data.forEach(employee => {
                    var option = document.createElement('option');
                    option.value = employee.first_name;
                    option.text = employee.first_name;
                    employeeDropdown.add(option);
                });
                
                employeeDropdown.selectedIndex = 0;
                typeDropdown.selectedIndex = 0;

                selectedEmployee = data.find(x => x.first_name === employeeDropdown.value);
                selectedType = 'Morning';

                employeeDropdown.addEventListener('change', function() {
                    selectedEmployee = data.find(x => x.first_name === this.value);
                });

                typeDropdown.addEventListener('change', function() {
                    selectedType = this.value;
                });

                submitButton.addEventListener('click', function() {
                    closeModal('employeeListModal');

                    fetch('/create_shift', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 'user_id': selectedEmployee.id, 'month': month, 'day': day, 'type': selectedType}),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
                    renderCalendar(currentMonth, currentYear);
                });


                document.getElementById('employeeListModal').style.display = 'block';
            }).catch(error => {
                console.error('Error fetching employees:', error);
            });
        }
        else {
            alert("Please select a date first.");
        }
    }


    function deleteShift() {
        fetch('/delete_shift', {
            method: 'DELETE',
             headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'id': selectedShift}),
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });

        renderCalendar(currentMonth, currentYear);
        getShifts();
    }

    function getShifts() {        
        fetch('/get_shifts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                // Authentication headers if necessary
            }).then(response => {
                return response.json();
            }).then(data => {
                // Assuming 'data' is an array of employee objects
                const morning = document.getElementById('shift-first');
                const evening = document.getElementById('shift-second');
                const night = document.getElementById('shift-third');

                morning.innerHTML = '';
                evening.innerHTML = '';
                night.innerHTML = '';

                data.forEach(shift => {
                    if (shift.day == selectedDate && shift.month == selectedMonth) {
                        const listItem = document.createElement('li');
                        
                        listItem.textContent = shift.first_name;
                        listItem.dataset.shiftID = JSON.stringify(shift.id);
                        listItem.classList.add('shift-display-content')
                        listItem.addEventListener('click', function() {
                            document.getElementById("add-remove-button").innerText = 'Remove Shift';

                            let selectedShifts = document.getElementsByClassName("shift-display-content");
                            for (let i = 0; i < selectedShifts.length; i++) {
                                selectedShifts[i].classList.remove('shift-display-selected');
                            }

                            this.classList.add('shift-display-selected');
                            selectedShift = JSON.parse(listItem.dataset.shiftID);
                        });

                        switch (shift.type) {
                            case 'Morning':
                                morning.appendChild(listItem);
                                break;
                            case 'Evening':
                                evening.appendChild(listItem);
                                break;
                            case 'Night':
                                night.appendChild(listItem);
                                break;
                        }
                    }
                });
                // Show the modal
                //document.getElementById('shiftListModal').style.display = 'block';
            }).catch(error => {
                console.error('Error fetching employees:', error);
            });
    }

    function renderCalendar(month, year) {
        const monthYearHeader = document.getElementById("monthYear");
        monthYearHeader.children[1].innerHTML = `${months[month]} ${year}`;

        startDay = new Date(year, month, 1).getDay();
        daysInMonth = new Date(year, month + 1, 0).getDate();

        let calendarBody = document.getElementById("calendarBody");
        calendarBody.innerHTML = ""; // Clear the previous cells

        let numRows = Math.ceil((startDay + daysInMonth)/7);

        let date = 1;
        for (let i = 0; i < numRows; i++) {
            let row = document.createElement("tr");

            for (let j = 0; j < 7; j++) {
                let cell = document.createElement("td");
                // ... handle cell content and styling
                
                // // Add click event for opening the modal here
                // cell.addEventListener('click', function() {
                //     // Show the modal
                //     modal.style.display = "block";
                    
                //     // Set the content based on the cell's data
                //     document.querySelector(".modal-content p").textContent = "You clicked on date " + cell.dataset.date;
                    
                //     // Remove 'selected' class from other cells and add to the clicked cell
                //     let cells = document.getElementsByTagName('td');
                //     for (let k = 0; k < cells.length; k++) {
                //         cells[k].classList.remove('selected');
                //     }
                //     cell.classList.add("selected");
                // });
                // row.appendChild(cell);

                if (i === 0 && j < startDay || date > daysInMonth) {
                    cell.innerHTML = "";
                } 
                else if (date <= daysInMonth) {
                    if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        cell.classList.add("highlight");
                    }
                    cell.dataset.date = JSON.stringify(date);
                    cell.dataset.month = JSON.stringify(month);

                    cell.innerHTML = `<span class="date-number">${date}</span>`;
                    date++;
                }
                cell.addEventListener('click', function() {
                    selectedDate = JSON.parse(cell.dataset.date);
                    selectedMonth = JSON.parse(cell.dataset.month);

                    selectCell();
                });
                row.appendChild(cell);
            }
            calendarBody.appendChild(row); // Append each row to the calendar body
        }

        if (selectedDate !== -1 && selectedMonth !== -1) {
            selectCell();
        }

        getShifts();
    }

    let metaKeyPressed = false;

    function selectCell() {
        try{
            document.getElementById("add-remove-button").innerText = 'Add Shift';
        }
        catch (e) {};

        let selectedShifts = document.getElementsByClassName("shift-display-content");
        for (let i = 0; i < selectedShifts.length; i++) {
            selectedShifts[i].classList.remove('shift-display-selected');
        }

        selectedShifts = null;

        let cells = document.getElementsByTagName('td');
        for (let k = 0; k < cells.length; k++) {
            let cell = cells[k];
            cell.classList.remove('selected');
        }  
             
        if (selectedMonth == JSON.parse(cells[15].dataset.month)) {
            cells[startDay + selectedDate - 1].classList.add("selected"); 
        }

        getShifts();
    }

    var modal = document.getElementById("myModal");
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        renderCalendar(currentMonth, currentYear);
    });

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    document.getElementById('revealDetailsButton').addEventListener('click', function() {
        let selectedCell = document.querySelector('.selected');
        if (selectedCell) {
            getShifts();
        } 
        else {
            alert("Please select a date first.");
        }
    });

</script>
{% endblock %}
